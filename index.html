<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Two-Click Translator</title>

<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = {
    theme: {
      extend: {
        colors: {
          'bg': '#0b0b0b',
          'card': '#111214',
          'panel': '#161617',
          'muted': '#bfc4c8',
        },
        fontFamily: {
          sans: ['Inter', 'ui-sans-serif', 'system-ui', '-apple-system', '"Segoe UI"', 'Roboto', '"Helvetica Neue"', 'Arial', 'sans-serif'],
        },
      }
    }
  }
</script>

<style>
  :root{
    --btn-h: 64px;
    --lang-ring: 4px;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:#eee;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
  .wrap{min-height:100%;display:flex;align-items:flex-start;justify-content:center;padding:28px;}
  .app{width:100%;max-width:420px;}
  .card{background:linear-gradient(180deg,#0f1112, #0b0b0b);border-radius:14px;padding:18px;box-shadow:0 8px 30px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.03);}
  .output{
    /* Removed position: relative; */
    height:84px;border-radius:10px;background:linear-gradient(180deg,#070708,#0b0b0b);display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:600;
    border:1px solid rgba(255,255,255,0.04);margin-bottom:14px; user-select:none;
    cursor: default; /* Changed from pointer to default */
    transition: background 0.15s ease;
  }
  /* Removed .output:active style */
  
  /* Removed audio-indicator styles */
  
  /* Span containing the main visible text */
  #outputText {
      transition: font-size 0.2s ease;
  }

  .lang-row{display:flex;gap:8px;margin-bottom:12px;}
  .lang-btn{flex:1;height:56px;border-radius:10px;border:none;font-weight:700;display:flex;align-items:center;justify-content:center;cursor:pointer;outline:0; position:relative;}
  .lang-btn:active{transform:translateY(1px)}
  .lang-btn.unselect{opacity:0.85}
  .lang-selected{
    box-shadow:0 6px 30px rgba(100,150,255,0.18);
    outline: none;
    border-radius:10px;
    position:relative;
    z-index:1;
  }
  .lang-selected::after{
    content:"";position:absolute;inset: -6px;border-radius:14px;opacity:0.7;pointer-events:none;
    box-shadow:0 0 30px currentColor; /* Uses the button's text color for the glow */
  }

  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;}
  .phrase-btn{height:var(--btn-h);background:#1e1e1e;color:#ffffff;border-radius:10px;border:1px solid rgba(255,255,255,0.05);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:600;cursor:pointer;white-space:pre-wrap;padding:6px;text-align:center; transition: all 0.05s;}
  .phrase-btn:active{transform:translateY(1px); box-shadow: 0 2px 4px rgba(0,0,0,0.5);}
  .small-muted{font-size:12px;color:#9da3a7;margin-top:8px;text-align:center}
  
  /* Modal Styles */
  .modal-bg{position:fixed;inset:0;background:linear-gradient(rgba(3,3,3,0.8),rgba(3,3,3,0.8));display:flex;align-items:center;justify-content:center;z-index:40}
  .modal{background:#111214;padding:18px;border-radius:12px;width:90%;max-width:360px;border:1px solid rgba(255,255,255,0.04); box-shadow:0 10px 40px rgba(0,0,0,0.7);}
  .modal h3{margin:0 0 12px 0;color:#fff;font-size:17px;font-weight:700;}
  .modal-input {
      width: 100%; padding: 12px; margin: 10px 0 16px; border-radius: 8px; 
      background: #0d0d0f; border: 1px solid rgba(255,255,255,0.1); 
      color: #fff; font-size: 16px; box-sizing: border-box;
      outline: none;
  }
  .modal-input:focus {
      border-color: #60a5fa;
  }
  .action-btn {
      width: 49%; padding: 12px; border-radius: 10px; font-weight: 700;
      transition: background 0.15s;
  }
  .action-confirm {
      background: #4ade80; color: #111; border: none;
  }
  .action-confirm:active {
      background: #22c55e;
  }
  .action-cancel {
      background: #333; color: #fff; border: none; width: 100%;
  }
  .action-cancel:active {
      background: #555;
  }

  @media (max-width:420px){
    :root{--btn-h:56px}
    .output{height:72px;font-size:18px}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="app card" role="application" aria-label="Translation Calculator">
    <div id="output" class="output" aria-live="polite">
                <span id="outputText">Hello</span>
        
            </div>

    <div id="langRow" class="lang-row" aria-hidden="false"></div>

    <div id="phrases" class="grid"></div>

    <div id="helpText" class="small-muted"></div>
  </div>
</div>

<div id="modalRoot" style="display:none;"></div>

<script>
(() => {
  
  // language metadata
  const LANGS = [
    {code:'en', native:'English', color:'#4ade80'},
    {code:'es', native:'Español', color:'#f87171'},
    {code:'fr', native:'Français', color:'#60a5fa'},
    {code:'it', native:'Italiano', color:'#fbbf24'},
    {code:'zh', native:'中文', color:'#a78bfa'},
    {code:'ru', native:'Русский', color:'#f472b6'},
    {code:'ar', native:'العربية', color:'#f97316'},
    {code:'pt', native:'Português', color:'#14b8a6'},
    {code:'hi', native:'हिन्दी', color:'#eab308'},
    {code:'ja', native:'日本語', color:'#f43f5e'},
  ];
  
  // Removed VOICE_MAP

  // display names for the languages in different display languages
  const languages_display_names = {
    en: { en:'English', es:'Spanish', fr:'French', it:'Italian', zh:'Chinese', ru:'Russian', ar:'Arabic', pt:'Portuguese', hi:'Hindi', ja:'Japanese' },
    es: { en:'Inglés', es:'Español', fr:'Francés', it:'Italiano', zh:'Chino', ru:'Ruso', ar:'Árabe', pt:'Portugués', hi:'Hindi', ja:'Japonés' },
    fr: { en:'Anglais', es:'Espagnol', fr:'Français', it:'Italien', zh:'Chinois', ru:'Russe', ar:'Arabe', pt:'Portugais', hi:'Hindi', ja:'Japonés' },
    it: { en:'Inglese', es:'Spagnolo', fr:'Francese', it:'Italiano', zh:'Cinese', ru:'Russo', ar:'Arabo', pt:'Portoghese', hi:'Giapponese', ja:'Giapponese' },
    zh: { en:'英语', es:'西班牙语', fr:'法语', it:'意大利语', zh:'中文', ru:'俄语', ar:'阿拉伯语', pt:'葡萄牙语', hi:'印地语', ja:'日语' },
    ru: { en:'Англ.', es:'Испан.', fr:'Франц.', it:'Итальян.', zh:'Кит.', ru:'Русский', ar:'Араб.', pt:'Португ.', hi:'Хинди', ja:'Япон.' },
    ar: { en:'الإنجليزية', es:'الإسبانية', fr:'الفرنسية', it:'الإيطالية', zh:'الصينية', ru:'الروسية', ar:'العربية', pt:'البرتغالية', hi:'الهندية', ja:'اليابانية' },
    pt: { en:'Inglês', es:'Espanhol', fr:'Francês', it:'Italiano', zh:'Chinês', ru:'Russo', ar:'Árabe', pt:'Português', hi:'Hindi', ja:'Japonés' },
    hi: { en:'अंग्रेज़ी', es:'स्पेनिश', fr:'फ्रेंच', it:'इटालियन', zh:'चीनी', ru:'रूसी', ar:'अरबी', pt:'पुर्तगाली', hi:'हिन्दी', ja:'जापानी' },
    ja: { en:'英語', es:'スペイン語', fr:'フランス語', it:'イタリア語', zh:'中国語', ru:'ロシア語', ar:'アラビア語', pt:'ポルトガル語', hi:'日本語', ja:'日本語' },
  };

  // Localization strings for the UI based on displayLang
  const UI_STRINGS = {
    en: { 
        help_text: "Tap a phrase to select, **double-click/press-and-hold (800ms) a phrase to type a new custom phrase**.", 
        custom_input_title: "Type New Phrase (Source: {lang_native})", 
        custom_input_label: "New Phrase in {lang_native}:", 
        confirm: "Confirm", 
        cancel: "Cancel", 
        translating: "Translating All...", 
        back_translating: "Translating to English source...",
        replace_button_title: "Replace {language} button with...",
        api_error: "API Error. Please set the GEMINI_API_KEY environment variable in Vercel.",
        temp_loading: "Loading...", // Used for text area when processing non-audio translations
        temp_error: "Error!",
    },
    es: { 
        help_text: "Toca una frase para seleccionar, **doble clic/mantener presionado (800ms) para escribir una nueva frase personalizada**.", 
        custom_input_title: "Escribir Nueva Frase (Fuente: {lang_native})", 
        custom_input_label: "Nueva Frase en {lang_native}:", 
        confirm: "Confirmar", 
        cancel: "Cancelar", 
        translating: "Traduciendo todo...", 
        back_translating: "Traduciendo al inglés para el sistema...",
        replace_button_title: "Reemplazar el botón de {language} por...",
        api_error: "Error de API. Establece la variable de entorno GEMINI_API_KEY en Vercel.",
        temp_loading: "Cargando...",
        temp_error: "¡Error!",
    },
    fr: { 
        help_text: "Appuyez sur une phrase pour sélectionner, **double-cliquez/appuyez et maintenez (800ms) pour taper une nouvelle phrase personnalisée**.", 
        custom_input_title: "Saisir une Nouvelle Phrase (Source: {lang_native})", 
        custom_input_label: "Nouvelle Phrase {lang_native}:", 
        confirm: "Confirmer", 
        cancel: "Annuler", 
        translating: "Traduction en cours...", 
        back_translating: "Traduction en anglais pour le système...",
        replace_button_title: "Remplacer le bouton {language} par...",
        api_error: "Erreur API. Veuillez définir la variable d'environnement GEMINI_API_KEY dans Vercel.",
        temp_loading: "Chargement...",
        temp_error: "Erreur!",
    },
    it: { 
        help_text: "Tocca una frase per selezionare, **doppio clic/tieni premuto (800ms) per digitare una nuova frase personalizzata**.", 
        custom_input_title: "Digita Nuova Frase (Fonte: {lang_native})", 
        custom_input_label: "Nuova Frase in {lang_native}:", 
        confirm: "Conferma", 
        cancel: "Annulla", 
        translating: "Traduzione in corso...", 
        back_translating: "Traduzione in inglese per il sistema...",
        replace_button_title: "Sostituisci il pulsante {language} con...",
        api_error: "Errore API. Imposta la variabile d'ambiente GEMINI_API_KEY in Vercel.",
        temp_loading: "Caricamento...",
        temp_error: "Errore!",
    },
    zh: { 
        help_text: "点击一个短语进行选择，**双击/按住 (800ms) 以输入新的自定义短语**。", 
        custom_input_title: "输入新短语（源: {lang_native}）", 
        custom_input_label: "新短语（{lang_native}）:", 
        confirm: "确认", 
        cancel: "取消", 
        translating: "正在翻译全部...", 
        back_translating: "翻译成英文源语言...",
        replace_button_title: "替换 {language} 按钮为...",
        api_error: "API 错误。请在 Vercel 中设置 GEMINI_API_KEY 环境变量。",
        temp_loading: "加载中...",
        temp_error: "错误!",
    },
    ru: { 
        help_text: "Нажмите на фразу, чтобы выбрать, **двойной клик/удерживайте (800ms) для ввода новой фразы**.", 
        custom_input_title: "Введите новую фразу (источник: {lang_native})", 
        custom_input_label: "Новая фраза на {lang_native}:", 
        confirm: "Подтвердить", 
        cancel: "Отмена", 
        translating: "Перевод всех...", 
        back_translating: "Перевод на английский язык для системы...",
        replace_button_title: "Заменить кнопку {language} на...",
        api_error: "Ошибка API. Установите переменную окружения GEMINI_API_KEY в Vercel.",
        temp_loading: "Загрузка...",
        temp_error: "Ошибка!",
    },
    ar: { 
        help_text: "انقر على عبارة للاختيار، **انقر نقرًا مزدوجًا/اضغط مع الاستمرار (800ms) لكتابة عبارة مخصصة جديدة**.", 
        custom_input_title: "اكتب عبارة جديدة (المصدر: {lang_native})", 
        custom_input_label: "العبارة الجديدة ({lang_native}):", 
        confirm: "تأكيد", 
        cancel: "إلغاء", 
        translating: "جاري ترجمة الكل...", 
        back_translating: "الترجمة إلى الإنجليزية للمصدر...",
        replace_button_title: "استبدال زر {language} بـ...",
        api_error: "خطأ في API. يرجى تعيين متغير البيئة GEMINI_API_KEY في Vercel.",
        temp_loading: "جاري التحميل...",
        temp_error: "خطأ!",
    },
    pt: { 
        help_text: "Toque em uma frase para selecionar, **clique duas vezes/pressione e segure (800ms) para digitar uma nova frase personalizada**.", 
        custom_input_title: "Digite Nova Frase (Fonte: {lang_native})", 
        custom_input_label: "Nova Frase em {lang_native}:", 
        confirm: "Confirmar", 
        cancel: "Cancelar", 
        translating: "Traduzindo tudo...", 
        back_translating: "Traduzindo para a fonte em inglês...",
        replace_button_title: "Substituir o botão {language} por...",
        api_error: "Erro de API. Por favor, defina a variável de ambiente GEMINI_API_KEY no Vercel.",
        temp_loading: "Carregando...",
        temp_error: "Erro!",
    },
    hi: { 
        help_text: "चुनने के लिए एक वाक्यांश पर टैप करें, **एक नया कस्टम वाक्यांश टाइप करने के लिए डबल-क्लिक/प्रेस-होल्ड (800ms) करें**।", 
        custom_input_title: "नया वाक्यांश टाइप करें (स्रोत: {lang_native})", 
        custom_input_label: "नया वाक्यांश ({lang_native}):", 
        confirm: "पुष्टि करें", 
        cancel: "रद्द करें", 
        translating: "सभी का अनुवाद हो रहा है...", 
        back_translating: "अंग्रेजी स्रोत में अनुवाद हो रहा है...",
        replace_button_title: "{language} बटन को इससे बदलें...",
        api_error: "API त्रुटि। कृपया Vercel में GEMINI_API_KEY पर्यावरण चर सेट करें।",
        temp_loading: "लोड हो रहा है...",
        temp_error: "त्रुटि!",
    },
    ja: { 
        help_text: "フレーズをタップして選択し、**新しいカスタムフレーズを入力するためにダブルクリック/長押し (800ms)**します。", 
        custom_input_title: "新しいフレーズを入力（ソース: {lang_native}）", 
        custom_input_label: "新しいフレーズ（{lang_native}）:", 
        confirm: "確認", 
        cancel: "キャンセル", 
        translating: "すべて翻訳中...", 
        back_translating: "英語ソースに翻訳中...",
        replace_button_title: "Replace {language} button with...",
        api_error: "APIエラー。Vercelで環境変数GEMINI_API_KEYを設定してください。",
        temp_loading: "ロード中...",
        temp_error: "エラー!",
    }
  };


  // --- Combined Initial Phrase Data ---
  // We only use the first 16 phrases as the active set.
  const INITIAL_ACTIVE_PHRASES_DATA = {
    en: [
        "Hello","How are you?","Good","Bad","Yes","No","Thank you","Please","Sorry","Excuse me","Good morning","Good night","I love you","Help","Stop","Go"
    ],
    es: [
        "Hola","¿Cómo estás?","Bien","Mal","Sí","No","Gracias","Por favor","Lo siento","Perdón","Buenos días","Buenas noches","Te quiero","Ayuda","Alto","Vamos"
    ],
    fr: [
        "Bonjour","Comment ça va?","Bien","Mal","Oui","Non","Merci","S'il vous plaît","Pardon","Excusez-moi","Bonjour (matin)","Bonne nuit","Je t'aime","Aidez-moi","Stop","Allons"
    ],
    it: [
        "Ciao","Come stai?","Bene","Mal","Sì","No","Grazie","Per favore","Mi dispiace","Scusa","Buongiorno","Buonanotte","Ti amo","Aiuto","Fermati","Andiamo"
    ],
    zh: [
        "你好","你好吗？","好","坏","是","不","谢谢","请","对不起","劳驾","早上好","晚安","我爱你","帮助","停","走"
    ],
    ru: [
        "Привет","Как дела?","Хорошо","Плохо","Да","Нет","Спасибо","Пожалуйста","Извини","Простите","Доброе утро","Спокойной ночи","Я тебя люблю","Помогите","Стоп","Идём"
    ],
    ar: [
        "مرحبا","كيف حالك؟","جيد","سيئ","نعم","لا","شكرا","من فضلك","آسف","عفوا","صباح الخير","تصبح على خير","أحبك","ساعدني","قف","هيا"
    ],
    pt: [
        "Olá","Como você está?","Bom","Ruim","Sim","Não","Obrigado","Por favor","Desculpe","Com licença","Bom dia","Boa noite","Eu te amo","Ajuda","Pare","Vamos"
    ],
    hi: [
        "नमस्ते","कैसे हैं?","अच्छा","बुरा","हाँ","नहीं","धन्यवाद","कृपया","माफ़ करें","सॉरी","सुप्रभात","शुभ रात्रि","मैं तुमसे प्यार करता हूँ","मदद","रुको","चलो"
    ],
    ja: [
        "こんにちは","お元気ですか？","良い","悪い","はい","いいえ","ありがとう","お願いします","ごめんなさい","失礼します","おはよう","おやすみ","愛してる","助けて","止まれ","行こう"
    ]
  };

  // PHRASES_BANK will hold the dynamic state: {en: [...], es: [...], ...} (just the active array)
  let PHRASES_BANK = {}; 

  // Function to initialize or reset a single language's bank
  function initializePhraseBank(code) {
      PHRASES_BANK[code] = INITIAL_ACTIVE_PHRASES_DATA[code]; 
  }

  // Load from storage or initialize all languages on first run
  const storedBank = localStorage.getItem('PHRASES_BANK');
  if (storedBank) {
      PHRASES_BANK = JSON.parse(storedBank);
      // Ensure all languages are initialized in case a new language was added since last save
      LANGS.forEach(l => {
          if (!PHRASES_BANK[l.code]) {
              initializePhraseBank(l.code);
          }
      });
  } else {
      // First run: use initial hardcoded translations to populate the bank
      LANGS.forEach(l => initializePhraseBank(l.code));
  }


  // initial state
  let displayLang = localStorage.getItem('displayLang') || 'en';      // what the UI shows (Input Language)
  let outputLang = localStorage.getItem('outputLang') || 'en';       // which language the translation uses (Output Language)
  let topRow = JSON.parse(localStorage.getItem('topRow')) || ['en','es','fr','it']; // first-row languages; index 0 fixed to 'en'
  let lastPhraseIndex = 0;
  // Removed isSpeaking flag

  const elOutput = document.getElementById('output');
  const elOutputText = document.getElementById('outputText'); // Span holding the main text
  const elLangRow = document.getElementById('langRow');
  const elPhrases = document.getElementById('phrases');
  const elHelpText = document.getElementById('helpText'); 
  const modalRoot = document.getElementById('modalRoot');

  // Removed Audio Indicator element references
  
  // Vercel Environment Variable Integration (CRITICAL LINE)
  const apiKey = typeof process !== 'undefined' && process.env && process.env.GEMINI_API_KEY
    ? process.env.GEMINI_API_KEY
    : ""; 

  // Persistence Helper
  function saveState() {
    localStorage.setItem('displayLang', displayLang);
    localStorage.setItem('outputLang', outputLang);
    localStorage.setItem('topRow', JSON.stringify(topRow));
    localStorage.setItem('PHRASES_BANK', JSON.stringify(PHRASES_BANK)); // Save the dynamic bank
  }

  // helpers
  function langMeta(code){ return LANGS.find(l=>l.code===code) || {code,label:code,color:'#666'}; }
  
  // hex to rgba small helper
  function hexToRgba(hex,alpha=1){
    const h = hex.replace('#','');
    const bigint = parseInt(h,16);
    const r = (bigint >> 16) & 255;
    const g = (bigint >> 8) & 255;
    const b = bigint & 255;
    return `rgba(${r},${g},${b},${alpha})`;
  }

  // Generic fetch with exponential backoff for API calls
  async function exponentialBackoffFetch(url, options, maxRetries = 5) {
      if (!apiKey) {
          throw new Error("API Key is missing. Cannot proceed with API call.");
      }
      for (let i = 0; i < maxRetries; i++) {
          try {
              // Ensure the apiKey is appended correctly
              const finalUrl = url.includes('?') ? `${url}&key=${apiKey}` : `${url}?key=${apiKey}`;
              
              const response = await fetch(finalUrl, options);
              if (response.ok) return response;
              
              if (response.status >=
